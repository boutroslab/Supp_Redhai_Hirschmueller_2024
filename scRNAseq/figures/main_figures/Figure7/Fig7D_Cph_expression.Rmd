---
title: "Check Cph expression for certain genes"
author: "Nick Hirschm√ºller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
set.seed(123)
```


## Introduction
This script is to check the expression of certain genes of interest.

```{r load libraries}
library(Seurat)
library(tidyverse)
library(patchwork)
library(here)
library(gprofiler2)
library(ggbeeswarm)
library(ggsignif)

# source plotting theme
source(here("plot_theme.R"))
source(here("helper_functions.R"))
```


```{r}
seurat <- readRDS(here("output", "RNAi_experiments_integrated.rds"))
seurat <- seurat[, seurat$perturbation %in% c("CphUp", "ctrl")]
seurat$perturbation <- factor(seurat$perturbation, levels = c("ctrl", "CphUp"))
```



```{r}
seurat$dummy <- ifelse(seurat$perturbation == "ctrl", "A", "B")
jitter_plot_fun <- function(srt, gene, population) {
    mdata <- srt@meta.data[, c("perturbation", "dummy")]
    exp_data <- FetchData(srt, gene)
    colnames(exp_data) <- gene
    stopifnot(all(rownames(mdata) == rownames(exp_data)))

    plot_data <- cbind(mdata, exp_data)
    p <- ggplot(plot_data, aes(x = perturbation, y = !!sym(gene))) +
        geom_point(mapping = aes(color = perturbation, fill = perturbation), size = 0.65, stroke = 0.4, shape = 21, position = position_jitterdodge(dodge.width = 0.9)) +
        geom_violin(
            mapping = aes(color = dummy),
            position = position_dodge(width = 0.9),
            fill = NA,
            adjust = 1, trim = TRUE,
            scale = "width", show.legend = F,
            width = 0.72 # adjust width so the violine does not stick out too much
        ) +
        theme_Publication_side_legend() %+%
        theme(
            axis.text.x = element_blank(),
            axis.title.x = element_blank(),
            legend.text = element_text(size = 15),
            legend.title = element_text(size = 16)
        ) +
        ylab("Expression\n(logcounts)") +
        guides(
            color = guide_legend(
                title = "Condition",
                override.aes = list(size = 2, alpha = 1, shape = NULL),
                hjust = 0
            ),
            fill = "none"
        ) +
        scale_y_continuous(expand = expansion(mult = c(0, 0.08))) +
        stat_summary(fun = "mean", geom = "point", aes(group = perturbation), color = "black", size = 3, shape = 8, stroke = 0.95, position = position_dodge(width = 0.9)) +
        scale_color_manual(
            values = c("ctrl" = color_mapping[1], "CphUp" = "#881394", A = "black", B = "black")
        ) +
        scale_fill_manual(values = alpha(c(color_mapping[1], "#881394"), 0.4)) +
        ggtitle(paste(population, gene)) +
        scale_y_continuous(expand = expansion(mult = c(0, 0.15)))+
        theme(legend.position = "none")


    return(p)
}

p <- jitter_plot_fun(seurat[, seurat$celltype_manual == "ISC"], "CG9650", "ISC")

annotation_df <- data.frame(
    dummy = c("A", "B"),
    y_position_ = c(3.6), # Adjust as needed
    xmin_ = c(1),
    xmax_ = c(2),
    label = c("***")
)

p<-p + geom_signif(
    data = annotation_df,
    aes(xmin = xmin_, xmax = xmax_, annotations = label, y_position = y_position_, group = dummy),
    textsize = 6.5, manual = TRUE, vjust = 0,
    inherit.aes = F
)


ggsave(
    plot = p,
    filename = here::here(
        "scRNAseq", "plots", "main", "Fig7D_Cph_expression_ISC.pdf"
    ),
    width = 2.9,
    height = 3,
    scale = 1.3
)

```




```{r}

```
