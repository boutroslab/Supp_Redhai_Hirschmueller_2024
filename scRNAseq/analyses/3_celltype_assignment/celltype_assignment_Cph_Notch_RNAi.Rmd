---
title: "Celltype assignment for Notch and Cph RNAi done manually"
author: "Nick Hirschm√ºller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

## Introduction
Celltype assignment


```{r}
library(Seurat)
library(tidyverse)
library(SingleR)
library(patchwork)
library(circlize)
library(ComplexHeatmap)
library(here)
library(SingleCellExperiment)
source(here("plot_theme.R"))
source(here("helper_functions.R"))
set.seed(123)
```

## Automatic cell type labeling

```{r}
# load integrated NotchCphRNAi dataset.
NotchCphRNAi <- readRDS(here("output", "NotchCphRNAi_seurat_TX49_rep1.rds"))

# currated table of marker genes based on the literature such as https://www.pnas.org/doi/10.1073/pnas.1916820117 or https://www.science.org/doi/10.1126/science.abk2432 or
# https://www.sciencedirect.com/science/article/pii/S2211124715006075
marker_table <- data.frame(
    gene = c(
        "alphaTry", "betaTry",
        "nub",
        "esg", "N",
        "Dl",
        "Vha100-4", "Vha16-1",
        "pros", "7B2",
        "PGRP-SC1b", "Jon65Ai",
        "LManVI", "iotaTry",
        "thetaTry", "Npc2f",
        "ct"
    ),
    celltype = c(
        "aEC", "aEC",
        "dEC",
        "EB", "EB",
        "ISC",
        "Copper", "Copper",
        "EE", "EE",
        "LFC", "LFC",
        "pEC", "pEC",
        "mEC", "mEC",
        "MT"
    )
)


# we still have to run the clustering for TX47, so far only for the integrated one but we are not using that.
NotchCphRNAi <- run_seurat_steps(NotchCphRNAi, include_norm = T, include_leiden = F, include_louvain = T, include_tsne = F)

Idents(NotchCphRNAi) <- factor(NotchCphRNAi$RNA_snn_res.1.3, levels = as.character(0:21))
p <- marker_heatmap(
    seurat = NotchCphRNAi,
    markers = marker_table$gene,
    celltype = marker_table$celltype,
    group.by = "RNA_snn_res.1.3",
    cap_value = 3
)
p

# based on the heatmap  assign the labels
# really hard to specifically pick out an ISC cluster.
NotchCphRNAi$celltype_manual <- case_when(
    NotchCphRNAi$RNA_snn_res.1.3 == 0 ~ "ISC",
    NotchCphRNAi$RNA_snn_res.1.3 == 1 ~ "ISC",
    NotchCphRNAi$RNA_snn_res.1.3 == 2 ~ "pEC",
    NotchCphRNAi$RNA_snn_res.1.3 == 3 ~ "aEC",
    NotchCphRNAi$RNA_snn_res.1.3 == 4 ~ "dEC", # ?
    NotchCphRNAi$RNA_snn_res.1.3 == 5 ~ "aEC",
    NotchCphRNAi$RNA_snn_res.1.3 == 6 ~ "aEC",
    NotchCphRNAi$RNA_snn_res.1.3 == 7 ~ "pEC",
    NotchCphRNAi$RNA_snn_res.1.3 == 8 ~ "aEC",
    NotchCphRNAi$RNA_snn_res.1.3 == 9 ~ "aEC",
    NotchCphRNAi$RNA_snn_res.1.3 == 10 ~ "mEC",
    NotchCphRNAi$RNA_snn_res.1.3 == 11 ~ "dEC", # ?
    NotchCphRNAi$RNA_snn_res.1.3 == 12 ~ "aEC",
    NotchCphRNAi$RNA_snn_res.1.3 == 13 ~ "Copper",
    NotchCphRNAi$RNA_snn_res.1.3 == 14 ~ "LFC",
    NotchCphRNAi$RNA_snn_res.1.3 == 15 ~ "EB",
    NotchCphRNAi$RNA_snn_res.1.3 == 16 ~ "mEC",
    NotchCphRNAi$RNA_snn_res.1.3 == 17 ~ "Copper",
    NotchCphRNAi$RNA_snn_res.1.3 == 18 ~ "ISC",
    NotchCphRNAi$RNA_snn_res.1.3 == 19 ~ "LFC",
    NotchCphRNAi$RNA_snn_res.1.3 == 20 ~ "ISC",
    NotchCphRNAi$RNA_snn_res.1.3 == 21 ~ "EE",
    T ~ NotchCphRNAi$RNA_snn_res.1.3
)

NotchCphRNAi$celltype_manual <- factor(NotchCphRNAi$celltype_manual, levels = c("ISC", "EB", "dEC", "aEC", "mEC", "Copper", "LFC", "pEC", "EE"))

marker_table$celltype <- factor(marker_table$celltype,
    levels = c("ISC", "EB", "dEC", "daEC", "aEC", "Copper", "mEC", "LFC", "pEC", "EE", "MT")
)

saveRDS(NotchCphRNAi, here("output", "NotchCphRNAi_seurat_TX49_rep1_annotated.rds"))
```


```{r, echo=T, message=T, error=T}
sessionInfo()
```
