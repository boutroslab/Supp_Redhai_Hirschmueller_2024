---
title: "MELD preprocessing"
author: "Nick Hirschm√ºller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
always_allow_html: yes
output:
  html_document:
    word_document:
    toc: yes
    toc_depth: '3'
    code_folding: hide
  pdf_document:
    number_sections: yes
    toc: false
    toc_depth: 3
editor_options: 
  chunk_output_type: console
---

## Introduction
MELD is a python tool, so we prepare the input data that we need here and then export it. 

```{r load libraries}
library(Seurat)
library(SingleCellExperiment)
library(tidyverse)
library(data.table)
library(patchwork)
library(here)

source(here("plot_theme.R"))
source(here("helper_functions.R"))
```




```{r}
seurat <- readRDS(here("output", "Ctrl_NotchKO_integrated_scent.rds"))
ctrl_split <- SplitObject(DietSeurat(seurat[, seurat$perturbation == "ctrl"], assays = "RNA"), "orig.ident")
notch_split <- SplitObject(DietSeurat(seurat[, seurat$perturbation == "notch"], assays = "RNA"), "orig.ident")
```

## Concatenate datasets
We do not do any integration here, simply merge dataset
```{r}
combined_list <- c(ctrl_split, notch_split)
merged_object <- merge(
    x = combined_list[[1]], y = combined_list[2:4] %>% unname(),
    project = "Notch_pertubation_merged",
    merge.data = F
)

# still no integration, just calculate PCA
merged_object <- NormalizeData(merged_object, normalization.method = "LogNormalize", scale.factor = 10000) %>%
    FindVariableFeatures(., selection.method = "vst", nfeatures = 3000) %>%
    ScaleData(.) %>%
    RunPCA(., npcs = 30, verbose = F) %>%
    RunUMAP(., reduction = "pca", dims = 1:20, verbose = F) 
```


After running the chunk below, we clearly see that there are strong batch effects. It looks like there is barely any overlap between the different batches (TX22&TX22_N vs TX23&TX23_N).
Thus, we split  the dataset into the different batches and then run MELD individually on them.
This was also discussed and recommended here: https://github.com/KrishnaswamyLab/MELD/issues/56 
```{r}
Idents(merged_object) <- factor(merged_object$orig.ident, levels = c("TX22", "TX23", "TX22_N", "TX23_N"))

merged_object@meta.data$test <- case_when(
    merged_object$orig.ident == "TX22" ~ "WT1",
    merged_object$orig.ident == "TX23" ~ "WT2",
    merged_object$orig.ident == "TX22_N" ~ "KO1",
    merged_object$orig.ident == "TX23_N" ~ "KO2",
)
Idents(merged_object) <- factor(merged_object$test, levels = c("WT1", "WT2", "KO1", "KO2"))

DimPlot(merged_object, pt.size = 0.45) +
    scale_color_manual(values = color_mapping) +
    small_axis("UMAP ") +
    ggtitle("TX22 and TX23 w/o integration")
```


Split the dataset again into the different experimentes.
```{r}
tx22 <- DietSeurat(merge(x = ctrl_split$TX22, y = notch_split$TX22_N, project = "TX22"))
tx23 <- DietSeurat(merge(x = ctrl_split$TX23, y = notch_split$TX23_N, project = "TX23"))

# wrapper to run Normalization, Scaling, PCA and UMAP
tx22 <- run_seurat_steps(tx22, include_leiden = F, include_tsne = F)
tx23 <- run_seurat_steps(tx23, include_leiden = F, include_tsne = F)

####################
# EXPORT TX22 DATA #
####################
Embeddings(tx22, "pca")[, 1:20] %>%
    data.frame() %>%
    rownames_to_column("cell_barcode") %>% 
    fwrite(., here("output", "MELD", "pca_data_tx22.tsv"),
    sep = "\t",
    row.names = F
)

tx22@meta.data %>%
    data.frame() %>%
    rownames_to_column("cell_barcode") %>% 
    fwrite(., here("output", "MELD", "mdata_tx22.tsv"),
    sep = "\t",
    row.names = F
)

tx22@assays$RNA@data %>%
    t() %>%
    data.frame() %>%
    rownames_to_column("cell_barcode") %>%
    fwrite(., file = here("output", "MELD", "norm_cnts_tx22.tsv"), sep = "\t", row.names = F)

tx22@assays$RNA@counts %>%
    t() %>%
    data.frame() %>%
    rownames_to_column("cell_barcode") %>%
    fwrite(., file = here("output", "MELD", "cnts_tx22.tsv"), sep = "\t", row.names = F)


####################
# EXPORT TX23 DATA #
####################
Embeddings(tx23, "pca")[, 1:20] %>%
    data.frame() %>%
    rownames_to_column("cell_barcode") %>% 
    fwrite(., here("output", "MELD", "pca_data_tx23.tsv"),
    sep = "\t",
    row.names = F
)

tx23@meta.data %>%
    data.frame() %>%
    rownames_to_column("cell_barcode") %>% 
    fwrite(., here("output", "MELD", "mdata_tx23.tsv"),
        sep = "\t",
        row.names = F
    )

tx23@assays$RNA@data %>%
    t() %>%
    data.frame() %>%
    rownames_to_column("cell_barcode") %>%
    fwrite(., file = here("output", "MELD", "norm_cnts_tx23.tsv"), sep = "\t", row.names = F)

tx23@assays$RNA@counts %>%
    t() %>%
    data.frame() %>%
    rownames_to_column("cell_barcode") %>%
    fwrite(., file = here("output", "MELD", "cnts_tx23.tsv"), sep = "\t", row.names = F)
```


```{r}
sessionInfo()
```












